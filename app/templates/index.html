<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staking Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #181c24 0%, #232a36 100%);
            color: #e5e7eb;
            padding: 0.5rem 0 0.5rem 0;
        }
        .max-w-4xl {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .balance-container {
            background: #232a36;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.12);
            border: 1px solid #232a36;
        }
        .balance-container:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.18);
        }
        .balance-title {
            color: #cbd5e1;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        .balance-amount {
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .form-container {
            background: #232a36;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.13);
            border: 1px solid #232a36;
        }
        .input-group {
            margin-bottom: 0.75rem;
        }
        .input-label {
            color: #cbd5e1;
            margin-bottom: 0.25rem;
            display: block;
            font-weight: 500;
            font-size: 0.97rem;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            background: #181c24;
            border: 1px solid #353b48;
            color: #e5e7eb;
            transition: all 0.2s ease;
            font-size: 0.97rem;
        }
        .input-field:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.13);
        }
        .btn {
            background: #2563eb;
            color: #fff;
            padding: 0.5rem 1.1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            border: none;
            font-size: 0.97rem;
        }
        .btn:hover {
            background: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.13);
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.13);
        }
        h1 {
            color: #fff;
            font-size: 1.7rem;
            font-weight: 700;
            margin-bottom: 1.2rem;
            margin-top: 0.5rem;
        }
        h2 {
            color: #e5e7eb;
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 0.7rem;
        }
        #minToleranceResult, #stakeListResult {
            color: #cbd5e1;
        }
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        .btn:disabled:hover {
            box-shadow: none;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .toggle-btn {
            background: transparent;
            border: none;
            color: #9CA3AF;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .toggle-btn:hover {
            color: #D1D5DB;
        }
        .toggle-btn .icon {
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 0.2s ease;
        }
        .toggle-btn.collapsed .icon {
            transform: rotate(-90deg);
        }
        .tab-bar {
            background: #232a36;
            border-radius: 0.6rem;
            padding: 0.1rem 0.2rem;
            display: flex;
            gap: 0.2rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.02);
            margin-bottom: 0.2rem;
        }
        .tab {
            font-weight: 600;
            padding: 0.35rem 1rem;
            border-radius: 0.4rem 0.4rem 0 0;
            background: none;
            border: none;
            outline: none;
            transition: color 0.2s, background 0.2s, box-shadow 0.2s;
            color: #a1a1aa;
            cursor: pointer;
            position: relative;
            font-size: 1rem;
        }
        .tab-active {
            color: #60a5fa;
            background: #181c24;
            box-shadow: 0 1px 4px rgba(96,165,250,0.09);
            z-index: 1;
        }
        .tab-inactive:hover {
            color: #60a5fa;
            background: #232a36;
        }
        .text-red-500 {
            color: #f87171;
        }
        .text-gray-400 {
            color: #a1a1aa;
        }
    </style>
</head>
<body class="bg-[#181c24] text-white min-h-screen p-4">
    <div class="max-w-4xl mx-auto" style="margin-top:0.1rem;margin-bottom:0.1rem;">
        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab tab-active" id="tab-balances" onclick="showTab('balances')">Balances</button>
            <button class="tab tab-inactive" id="tab-stake" onclick="showTab('stake')">Stake</button>
            <button class="tab tab-inactive" id="tab-unstake" onclick="showTab('unstake')">Unstake</button>
            <button class="tab tab-inactive" id="tab-calc" onclick="showTab('calc')">Min Tolerance Calculator</button>
        </div>
        <!-- Tab Contents -->
        <div id="tabContent-balances">
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">Wallet Free Balances</h2>
                <div id="balanceContainer">
                    {{ balance_html | safe }}
                </div>
            </div>
        </div>
        <div id="tabContent-stake" style="display:none;">
            <div class="form-container mb-8">
                <h2 class="text-xl font-semibold mb-4">Stake TAO</h2>
                <div class="input-group">
                    <label class="input-label">Wallet Name</label>
                    <select id="stakeWalletName" class="input-field">
                        {% for wallet in wallet_names %}
                            <option value="{{ wallet }}" {% if loop.first %}selected{% endif %}>{{ wallet }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">TAO Amount</label>
                    <input type="text" id="stakeAmount" class="input-field" step="0.000001" min="0">
                </div>
                <div class="input-group">
                    <label class="input-label">Network ID</label>
                    <input type="text" id="netuid" class="input-field" value="0">
                </div>
                <div class="input-group">
                    <label class="input-label">Rate Tolerance</label>
                    <div class="flex items-center gap-3">
                        <input type="text" id="rateTolerance" class="input-field flex-1" value="0.005" step="0.0001">
                        <input type="checkbox" id="minToleranceStaking" class="form-checkbox h-4 w-4 text-blue-600" checked onchange="toggleRateTolerance()">
                        <label for="minToleranceStaking" class="text-sm text-red-500 mb-0">Use Min Tolerance</label>
                    </div>
                    <p class="text-sm text-gray-400 mt-1" id="rateToleranceNote">This value will be ignored when "Use Minimum Tolerance" is checked</p>
                </div>
                <div class="input-group">
                    <label class="input-label">Validator Hotkey</label>
                    <input type="text" id="stakeValidatorHotkey" class="input-field" value="5Gq2gs4ft5dhhjbHabvVbAhjMCV2RgKmVJKAFCUWiirbRT21">
                </div>
                <div class="input-group">
                    <label class="input-label">Retries (optional)</label>
                    <input type="text" id="stakeRetries" class="input-field" value="1" placeholder="Leave blank for default">
                </div>
                <button onclick="stake()" class="btn">Stake</button>
            </div>
        </div>
        <div id="tabContent-unstake" style="display:none;">
            <div class="form-container mb-8">
                <h2 class="text-xl font-semibold mb-4">Unstake</h2>
                <div class="input-group">
                    <label class="input-label">Wallet Name</label>
                    <select id="unstakeWalletName" class="input-field">
                        {% for wallet in wallet_names %}
                            <option value="{{ wallet }}" {% if loop.first %}selected{% endif %}>{{ wallet }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Amount (optional)</label>
                    <input type="text" id="unstakeAmount" class="input-field" placeholder="Leave blank to unstake all">
                </div>
                <div class="input-group">
                    <label class="input-label">Network ID</label>
                    <input type="text" id="unstakeNetuid" class="input-field" value="0">
                </div>
                <div class="input-group">
                    <label class="input-label">Rate Tolerance</label>
                    <div class="flex items-center gap-3">
                        <input type="text" id="unstakeRateTolerance" class="input-field flex-1" value="0.005" step="0.0001">
                        <input type="checkbox" id="minToleranceUnstaking" class="form-checkbox h-4 w-4 text-blue-600" checked onchange="toggleUnstakeRateTolerance()">
                        <label for="minToleranceUnstaking" class="text-sm text-red-500 mb-0">Use Min Tolerance</label>
                    </div>
                    <p class="text-sm text-gray-400 mt-1" id="unstakeRateToleranceNote">This value will be ignored when "Use Minimum Tolerance" is checked</p>
                </div>
                <div class="input-group">
                    <label class="input-label">Validator Hotkey</label>
                    <input type="text" id="unstakeValidatorHotkey" class="input-field" value="5Gq2gs4ft5dhhjbHabvVbAhjMCV2RgKmVJKAFCUWiirbRT21">
                </div>
                <div class="input-group">
                    <label class="input-label">Retries (optional)</label>
                    <input type="text" id="unstakeRetries" class="input-field" value="1" placeholder="Leave blank for default">
                </div>
                <button onclick="unstake()" class="btn btn-danger">Unstake</button>
            </div>
        </div>
        <div id="tabContent-calc" style="display:none;">
            <div class="form-container mb-8">
                <h2 class="text-xl font-semibold mb-4">Min Tolerance Calculator</h2>
                <div class="input-group">
                    <label class="input-label">TAO Amount</label>
                    <input type="text" id="calcAmount" class="input-field" step="0.000001" min="0">
                </div>
                <div class="input-group">
                    <label class="input-label">Network ID</label>
                    <input type="text" id="calcNetuid" class="input-field" value="0">
                </div>
                <button onclick="calculateMinTolerance()" class="btn">Calculate</button>
                <div id="minToleranceResult" class="mt-4 text-gray-300"></div>
            </div>
        </div>
    </div>

    <script>
        // Tab logic
        function showTab(tab) {
            const tabs = ['balances', 'stake', 'unstake', 'calc'];
            tabs.forEach(t => {
                document.getElementById('tabContent-' + t).style.display = (t === tab) ? '' : 'none';
                document.getElementById('tab-' + t).classList.toggle('tab-active', t === tab);
                document.getElementById('tab-' + t).classList.toggle('tab-inactive', t !== tab);
            });
        }
        // Set default tab
        showTab('balances');

        // Fetch and display balances
        async function fetchBalances() {
            try {
                const response = await fetch('/');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const balanceContainer = doc.querySelector('#balanceContainer');
                document.getElementById('balanceContainer').innerHTML = balanceContainer.innerHTML;
                
                // Update wallet select options
                updateWalletSelect();
            } catch (error) {
                console.error('Error fetching balances:', error);
            }
        }

        // Update wallet select options
        function updateWalletSelect() {
            const balanceContainer = document.getElementById('balanceContainer');
            const walletElements = balanceContainer.querySelectorAll('.balance-container');
            const stakeSelect = document.getElementById('stakeWalletName');
            const unstakeSelect = document.getElementById('unstakeWalletName');
            
            // Clear existing options except the first one for stake select
            while (stakeSelect.options.length > 1) {
                stakeSelect.remove(1);
            }
            
            // Clear existing options except stake_2 for unstake select
            while (unstakeSelect.options.length > 1) {
                unstakeSelect.remove(1);
            }
            
            // Add new options from balance container
            walletElements.forEach(element => {
                const walletName = element.querySelector('.balance-title').textContent.trim();
                
                // Add to stake select
                const stakeOption = document.createElement('option');
                stakeOption.value = walletName;
                stakeOption.textContent = walletName;
                stakeSelect.appendChild(stakeOption);
                
                // Add to unstake select
                const unstakeOption = document.createElement('option');
                unstakeOption.value = walletName;
                unstakeOption.textContent = walletName;
                unstakeSelect.appendChild(unstakeOption);
            });
        }

        // Helper function to set button loading state
        function setButtonLoading(button, isLoading) {
            const originalText = button.getAttribute('data-original-text') || button.innerHTML;
            if (isLoading) {
                button.setAttribute('data-original-text', originalText);
                button.innerHTML = `<span class="loading-spinner"></span>${originalText}`;
                button.disabled = true;
            } else {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Stake function
        async function stake() {
            const button = document.querySelector('button[onclick="stake()"]');
            const walletName = document.getElementById('stakeWalletName').value;
            const amount = document.getElementById('stakeAmount').value;
            const netuid = document.getElementById('netuid').value;
            const rateTolerance = document.getElementById('rateTolerance').value;
            const validatorHotkey = document.getElementById('stakeValidatorHotkey').value;
            const minToleranceStaking = document.getElementById('minToleranceStaking').checked;
            const retries = document.getElementById('stakeRetries').value;

            if (!walletName) {
                alert('Please select a wallet');
                return;
            }

            // Add confirmation dialog
            const confirmMessage = `Are you sure you want to stake ${amount} TAO from wallet "${walletName}" to validator "${validatorHotkey}" on network ${netuid}?`;
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                setButtonLoading(button, true);
                let url = `/stake?wallet_name=${walletName}&tao_amount=${amount}&netuid=${netuid}&rate_tolerance=${rateTolerance}&dest_hotkey=${validatorHotkey}&min_tolerance_staking=${minToleranceStaking}`;
                if (retries) {
                    url += `&retries=${retries}`;
                }
                const response = await fetch(url);
                const result = await response.json();
                alert(JSON.stringify(result));
            } catch (error) {
                console.error('Error staking:', error);
                alert('Error staking. Please try again.');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Unstake function
        async function unstake() {
            const button = document.querySelector('button[onclick="unstake()"]');
            const walletName = document.getElementById('unstakeWalletName').value;
            const netuid = document.getElementById('unstakeNetuid').value;
            const validatorHotkey = document.getElementById('unstakeValidatorHotkey').value;
            const amount = document.getElementById('unstakeAmount').value;
            const rateTolerance = document.getElementById('unstakeRateTolerance').value;
            const minToleranceUnstaking = document.getElementById('minToleranceUnstaking').checked;
            const retries = document.getElementById('unstakeRetries').value;

            if (!walletName) {
                alert('Please select a wallet');
                return;
            }

            // Add confirmation dialog
            const amountText = amount ? `${amount} TAO` : 'all TAO';
            const confirmMessage = `Are you sure you want to unstake ${amountText} from wallet "${walletName}" from validator "${validatorHotkey}" on network ${netuid}?`;
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                setButtonLoading(button, true);
                let url = `/unstake?wallet_name=${walletName}&netuid=${netuid}&dest_hotkey=${validatorHotkey}&rate_tolerance=${rateTolerance}&min_tolerance_unstaking=${minToleranceUnstaking}`;
                if (amount) {
                    url += `&amount=${amount}`;
                }
                if (retries) {
                    url += `&retries=${retries}`;
                }
                const response = await fetch(url);
                const result = await response.json();
                alert(JSON.stringify(result));
            } catch (error) {
                console.error('Error unstaking:', error);
                alert('Error unstaking. Please try again.');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Calculate min tolerance
        async function calculateMinTolerance() {
            const button = document.querySelector('button[onclick="calculateMinTolerance()"]');
            const amount = document.getElementById('calcAmount').value;
            const netuid = document.getElementById('calcNetuid').value;

            try {
                setButtonLoading(button, true);
                const response = await fetch(`/min_tolerance?tao_amount=${amount}&netuid=${netuid}`);
                const result = await response.json();
                document.getElementById('minToleranceResult').textContent = 
                    `Minimum tolerance: ${result.min_tolerance.toFixed(6)}`;
            } catch (error) {
                console.error('Error calculating min tolerance:', error);
                alert('Error calculating min tolerance. Please try again.');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Add this new function at the beginning of your script section
        function toggleRateTolerance() {
            const rateToleranceInput = document.getElementById('rateTolerance');
            const minToleranceChecked = document.getElementById('minToleranceStaking').checked;
            
            rateToleranceInput.disabled = minToleranceChecked;
            if (minToleranceChecked) {
                rateToleranceInput.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                rateToleranceInput.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function toggleUnstakeRateTolerance() {
            const rateToleranceInput = document.getElementById('unstakeRateTolerance');
            const minToleranceChecked = document.getElementById('minToleranceUnstaking').checked;
            
            rateToleranceInput.disabled = minToleranceChecked;
            if (minToleranceChecked) {
                rateToleranceInput.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                rateToleranceInput.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Call this function when the page loads to set initial state
        document.addEventListener('DOMContentLoaded', function() {
            toggleRateTolerance();
            toggleUnstakeRateTolerance();
        });

        // Initial balance fetch
        fetchBalances(); 
    </script>
</body>
</html> 